<?php
/* ***** BEGIN LICENSE BLOCK *****
 * Version: MPL 1.1/GPL 2.0/LGPL 2.1
 *
 * The contents of this file are subject to the Mozilla Public License Version
 * 1.1 (the "License"); you may not use this file except in compliance with
 * the License. You may obtain a copy of the License at
 * http://www.mozilla.org/MPL/
 *
 * Software distributed under the License is distributed on an "AS IS" basis,
 * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
 * for the specific language governing rights and limitations under the
 * License.
 *
 * The Original Code is KaiRo's userAgent detection.
 *
 * The Initial Developer of the Original Code is
 * KaiRo - Robert Kaiser.
 * Portions created by the Initial Developer are Copyright (C) 2003-2007
 * the Initial Developer. All Rights Reserved.
 *
 * Contributor(s): Robert Kaiser <kairo@kairo.at>
 *
 * Alternatively, the contents of this file may be used under the terms of
 * either the GNU General Public License Version 2 or later (the "GPL"), or
 * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
 * in which case the provisions of the GPL or the LGPL are applicable instead
 * of those above. If you wish to allow use of your version of this file only
 * under the terms of either the GPL or the LGPL, and not to allow others to
 * use your version of this file under the terms of the MPL, indicate your
 * decision by deleting the provisions above and replace them with the notice
 * and other provisions required by the GPL or the LGPL. If you do not delete
 * the provisions above, a recipient may use your version of this file under
 * the terms of any one of the MPL, the GPL or the LGPL.
 *
 * ***** END LICENSE BLOCK ***** */

class userAgent {
  // userAgent PHP class
  // get user agent and tell us what Browser is accessing
  //
  // function __construct([$ua_string])
  //   CONSTRUCTOR; reads UA string (or takes the optional given UA string) and gets info from that into our variables.
  //
  // private $uastring
  //   the plain User Agent string
  // private $brand
  //   the User Agent brand name
  // private $version
  //   the User Agent version
  // private $bot
  //   bool: true if this agent is a bot
  // private $mobile
  //   bool: true if this agent is a mobile phone
  // private $uadata
  //   array of static user agent data (static vars in functions are set for all objects of this class!)
  //
  // public function getBrand()
  //   returns the User Agent Brand Name
  //
  // public function getVersion()
  //   returns the User Agent version
  //
  // public function getAcceptLanguages()
  //   returns an associated array with the accepted languages of this UA
  //     keys are language codes, values are q factors (weights)
  //
  // public function getUAString()
  //   returns the full User Agent string
  //
  // public function getEngine()
  //   returns a string telling the detected rendering engine, null if we can't detect
  //     one of gecko|khtml|trident|tasman|nscp|presto|gzilla|gtkhtml|links|icestorm|unknown
  //
  // public function hasEngine($rnd_engine)
  //   returns true if the given rendering engine was detected
  //
  // public function getEngineVersion()
  //   returns a the version number for the rendering engine
  //     this may be the same as getVersion() for many engines, or null if we don't know
  //
  // public function getOS()
  //   returns a string telling the detected operating system, null if we can't detect
  //     might be very verbose, uses no abbreviations for most names
  //
  // public function getPlatform()
  //   returns a string telling the detected OS platform, null if we can't detect
  //     one of windows|linux|mac|solaris|unknown
  //
  // public function getLanguage() {
  //   returns a string telling the detected browser UI language, null if we can't detect
  //     should be an ISO code
  //
  // public function isBot()
  //   returns true if User Agent seems to be a bot
  //
  // public function isMobile()
  //   returns true if User Agent seems to be a mobile phone
  //
  // *** functions that only return useable info for some agents ***
  //
  // public function getGeckoDate()
  //   returns the Gecko date for Gecko-based browsers, null for others
  //
  // public function getGeckoTime()
  //   returns the Gecko build date/time as a unix epoch time number for Gecko-based browsers, null for others
  //
  // *** functions for compat to older versions of this class ***
  //
  // public function isns()
  //   returns true if User Agent seems to be Netscape brand, false if not
  // public function isns4()
  //   returns true if User Agent seems to be Netscape Communicator 4.x, false if not
  // public function isie()
  //   returns true if User Agent seems to be a version of Internet Exploder, false if not
  // public function geckobased()
  //   returns true if User Agent seems to be a Gecko-based browser, false if not
  // public function geckodate()
  //   returns the Gecko date when it's a Gecko-based browser, 0 if not
  // public function khtmlbased()
  //   returns true if User Agent seems to be a KHTML-based browser, false if not

  // collection of some known User Agent Strings:
  // *** see testbed/ua_list_raw.txt ***
  // *** see also http://www.pgts.com.au/pgtsj/pgtsj0208c.html ***

  private $uastring;
  private $brand;
  private $version;
  private $bot = false;
  private $mobile = false;
  private $uadata = array();

  function __construct($ua_string = '') {
    // *** constructor ***
    if (strlen($ua_string)) {
      $this->uastring = $ua_string;
    }
    else {
      // read raw UA string
      $this->uastring = $_SERVER['HTTP_USER_AGENT'];
    }

    // get UA brand and version
    $this->brand = 'Unknown'; $this->version = null;
    // find reasonable defaults
    if (preg_match('|([0-9a-zA-Z\.:()_ -]+)/(\d[0-9a-zA-Z\._+-]*)|', $this->uastring, $regs)) {
      $this->brand = trim($regs[1]);
      $this->version = $regs[2];
    }
    elseif (preg_match('|^([a-zA-Z\._ -]+)[_ -][vV]?(\d[0-9a-zA-Z\.+]*)|', $this->uastring, $regs)) {
      $this->brand = trim($regs[1]);
      $this->version = $regs[2];
    }
    elseif (preg_match('|^([0-9a-zA-Z\._ -]+)|', $this->uastring, $regs)) {
      $this->brand = trim($regs[1]);
      $this->version = null;
    }
    $this->bot = (strpos(strtolower($this->brand), 'bot') !== false)
                 || (strpos(strtolower($this->brand), 'crawler') !== false)
                 || (strpos(strtolower($this->brand), 'spider') !== false)
                 || (strpos(strtolower($this->brand), 'search') !== false)
                 || (strpos(strtolower($this->brand), 'seek') !== false);

    // search for any real and/or special UAs
    if (preg_match('|Netscape6/([0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) {
      $this->brand = 'Netscape';
      $this->version = $regs[1];
      $this->bot = false;
    }
    elseif (preg_match('|Netscape/([0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) {
      $this->brand = 'Netscape';
      $this->version = $regs[1];
      $this->bot = false;
    }
    elseif (preg_match('|Navigator/([0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) {
      $this->brand = 'Netscape';
      $this->version = $regs[1];
      $this->bot = false;
    }
    elseif (preg_match('|Chimera/([0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) {
      $this->brand = 'Chimera';
      $this->version = $regs[1];
      $this->bot = false;
    }
    elseif (preg_match('|Camino/([0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) {
      $this->brand = 'Camino';
      $this->version = $regs[1];
      $this->bot = false;
    }
    elseif (preg_match('|Phoenix/([0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) {
      $this->brand = 'Phoenix';
      $this->version = $regs[1];
      $this->bot = false;
    }
    elseif (preg_match('|Mozilla Firebird/([0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) {
      $this->brand = 'Mozilla Firebird';
      $this->version = $regs[1];
      $this->bot = false;
    }
    elseif (preg_match('|Flock/([0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) {
      $this->brand = 'Flock';
      $this->version = $regs[1];
      $this->bot = false;
    }
    elseif (preg_match('|SeaMonkey/([0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) {
      $this->brand = 'SeaMonkey';
      $this->version = $regs[1];
      $this->bot = false;
    }
    elseif (preg_match('|Iceape/([0-9a-zA-Z\.+]+)|i', $this->uastring, $regs)) {
      $this->brand = 'IceApe'; // Debian-rebranded SeaMonkey
      $this->version = $regs[1];
      $this->bot = false;
    }
    elseif (preg_match('|Iceweasel/([0-9a-zA-Z\.+]+)|i', $this->uastring, $regs)) {
      $this->brand = 'IceWeasel'; // Debian-rebranded Firefox
      $this->version = $regs[1];
      $this->bot = false;
    }
    elseif (preg_match('|Icedove/([0-9a-zA-Z\.+]+)|i', $this->uastring, $regs)) {
      $this->brand = 'IceDove'; // Debian-rebranded Thunderbird
      $this->version = $regs[1];
      $this->bot = false;
    }
    elseif (preg_match('|BonEcho/([0-9a-zA-Z\.+]+)|i', $this->uastring, $regs)) {
      $this->brand = 'Bon Echo'; // Firefox 2.0 code name
      $this->version = $regs[1];
      $this->bot = false;
    }
    elseif (preg_match('|GranParadiso/([0-9a-zA-Z\.+]+)|i', $this->uastring, $regs)) {
      $this->brand = 'Gran Paradiso'; // Firefox 3.0 code name
      $this->version = $regs[1];
      $this->bot = false;
    }
    elseif (preg_match('|Shiretoko/([0-9a-zA-Z\.+]+)|i', $this->uastring, $regs)) {
      $this->brand = 'Shiretoko'; // Firefox 3.5 code name
      $this->version = $regs[1];
      $this->bot = false;
    }
    elseif (preg_match('|Namoroka/([0-9a-zA-Z\.+]+)|i', $this->uastring, $regs)) {
      $this->brand = 'Namoroka'; // Firefox 3.6 code name
      $this->version = $regs[1];
      $this->bot = false;
    }
    elseif (preg_match('|Lorentz/([0-9a-zA-Z\.+]+)|i', $this->uastring, $regs)) {
      $this->brand = 'Lorentz'; // Firefox 3.6 (with OOPP) code name
      $this->version = $regs[1];
      $this->bot = false;
    }
    elseif (preg_match('|Minefield/([0-9a-zA-Z\.+]+)|i', $this->uastring, $regs)) {
      $this->brand = 'Minefield'; // Firefox development nightly code name
      $this->version = $regs[1];
      $this->bot = false;
    }
    elseif (preg_match('|PmWFx/([0-9a-zA-Z\.+]+)|i', $this->uastring, $regs)) {
      $this->brand = 'PmW-Firefox';
      $this->version = $regs[1];
      $this->bot = false;
    }
    elseif (preg_match('|BeZillaBrowser/([0-9a-zA-Z\.+]+)|i', $this->uastring, $regs)) {
      $this->brand = 'BeZillaBrowser';
      $this->version = $regs[1];
      $this->bot = false;
    }
    elseif (preg_match('|Songbird/([0-9a-zA-Z\.+]+)|i', $this->uastring, $regs)) {
      $this->brand = 'Songbird';
      $this->version = $regs[1];
      $this->bot = false;
    }
    elseif (preg_match('|Lanikai/([0-9a-zA-Z\.+]+)|i', $this->uastring, $regs)) {
      $this->brand = 'Lanikai'; // Thunderbird 3.1 code name
      $this->version = $regs[1];
      $this->bot = false;
    }
    elseif (preg_match('|Shredder/([0-9a-zA-Z\.+]+)|i', $this->uastring, $regs)) {
      $this->brand = 'Shredder'; // Thunderbird development nightly code name
      $this->version = $regs[1];
      $this->bot = false;
    }
    elseif (preg_match('|prism/([0-9a-zA-Z\.+]+)|i', $this->uastring, $regs)) {
      $this->brand = 'Prism';
      $this->version = $regs[1];
      $this->bot = false;
    }
    elseif (preg_match('|Minimo/([0-9a-zA-Z\.+]+)|i', $this->uastring, $regs)) {
      $this->brand = 'Minimo';
      $this->version = $regs[1];
      $this->bot = false;
      $this->mobile = true;
    }
    elseif (preg_match('|Fennec/([0-9a-zA-Z\.+]+)|i', $this->uastring, $regs)) {
      $this->brand = 'Fennec'; // Firefox mobile code name
      $this->version = $regs[1];
      $this->bot = false;
      $this->mobile = true;
    }
    elseif (preg_match('|Galeon/([0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) {
      $this->brand = 'Galeon';
      $this->version = $regs[1];
      $this->bot = false;
    }
    elseif (preg_match('|Epiphany/([0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) {
      $this->brand = 'Epiphany';
      $this->version = $regs[1];
      $this->bot = false;
    }
    elseif (preg_match('|K-Meleon/([0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) {
      $this->brand = 'K-Meleon';
      $this->version = $regs[1];
      $this->bot = false;
    }
    elseif (preg_match('|AOL[/ ]([0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) {
      $this->brand = 'AOL';
      $this->version = $regs[1];
      $this->bot = false;
    }
    elseif (preg_match('|Tablet browser ([0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) {
      $this->brand = 'microB';
      $this->version = $regs[1];
      $this->bot = false;
      $this->mobile = true;
    }
    elseif (preg_match('|Maemo Browser ([0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) {
      $this->brand = 'microB';
      $this->version = $regs[1];
      $this->bot = false;
      $this->mobile = true;
    }
    elseif (preg_match('|Opera\/([^\(]+) \(.*; Opera Mini; |', $this->uastring, $regs)) {
      $this->brand = 'Opera Mini';
      $this->version = $regs[1];
      $this->bot = false;
      $this->mobile = true;
    }
    elseif (preg_match('/Opera\/[^\(]+ \(.*; Opera Mini\/([^;]+); /i', $this->uastring, $regs)) {
      $this->brand = 'Opera Mini';
      $this->version = $regs[1];
      $this->bot = false;
      $this->mobile = true;
    }
    elseif (preg_match('|Opera[ /]([0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) {
      $this->brand = 'Opera';
      $this->version = $regs[1];
      $this->bot = false;
    }
    elseif (preg_match('|OmniWeb/([0-9a-zA-Z\.+-]+)|', $this->uastring, $regs)) {
      $this->brand = 'OmniWeb';
      $this->version = $regs[1];
      $this->bot = false;
    }
    elseif (preg_match('|Konqueror/([0-9a-zA-Z\.+]+)|i', $this->uastring, $regs)) {
      $this->brand = 'Konqueror';
      $this->version = $regs[1];
      $this->bot = false;
    }
    elseif (preg_match('|Shiira/([0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) {
      $this->brand = 'Shiira';
      $this->version = $regs[1];
      $this->bot = false;
    }
    elseif (preg_match('|Edge/([0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) {
      $this->brand = 'Edge';
      $this->version = $regs[1];
      $this->bot = false;
    }
    elseif (preg_match('|Chromium/([0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) {
      $this->brand = 'Chromium';
      $this->version = $regs[1];
      $this->bot = false;
    }
    elseif (preg_match('|Chrome/([0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) {
      $this->brand = 'Chrome';
      $this->version = $regs[1];
      $this->bot = false;
    }
    elseif (preg_match('|NokiaBrowser/([0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) {
      $this->brand = 'NokiaBrowser';
      $this->version = $regs[1];
      $this->bot = false;
    }
    elseif (preg_match('|wOSBrowser/([0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) {
      $this->brand = 'webOS Browser';
      $this->version = $regs[1];
      $this->bot = false;
    }
    elseif (preg_match('|Silk/([0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) {
      $this->brand = 'Silk';
      $this->version = $regs[1];
      $this->bot = false;
    }
    elseif (preg_match('|Kindle/([0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) {
      $this->brand = 'Kindle';
      $this->version = $regs[1];
      $this->bot = false;
    }
    elseif (preg_match('|Pre/([0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) {
      $this->brand = 'Pre';
      $this->version = $regs[1];
      $this->bot = false;
    }
    elseif (preg_match('|BOLT/([0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) {
      $this->brand = 'BOLT';
      $this->version = $regs[1];
      $this->bot = false;
    }
    elseif (preg_match('|Googlebot-Mobile/([0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) { /* looks like Webkit! */
      $this->brand = 'Googlebot-Mobile';
      $this->version = $regs[1];
      $this->bot = true;
      $this->mobile = true;
    }
    elseif (preg_match('|Safari/([0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) {
      if (preg_match('| Mobile(/[0-9a-zA-Z\.+]+)? ?Safari/|', $this->uastring)) {
        $this->brand = 'Mobile Safari';
        $this->mobile = true;
      }
      else {
        $this->brand = 'Safari';
      }
      if (preg_match('|Version/([0-9a-zA-Z\.+]+)|', $this->uastring, $vregs)) {
        $this->version = $vregs[1];
      }
      else {
        $this->version = '('.$regs[1].')';
      }
      $this->bot = false;
    }
    elseif (preg_match('|AppleWebKit/([0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) {
      $this->brand = 'AppleWebKit';
      $this->version = $regs[1];
      $this->bot = false;
    }
    elseif (preg_match('|Spinn3r ([0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) { /* looks like Gecko! */
      $this->brand = 'Spinn3r';
      $this->version = $regs[1];
      $this->bot = true;
    }
    elseif (preg_match('|Butterfly/([0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) { /* looks like Gecko! */
      $this->brand = 'Butterfly';
      $this->version = $regs[1];
      $this->bot = true;
    }
    elseif (preg_match('|Googlebot/([0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) { /* looks like Gecko! */
      $this->brand = 'Googlebot';
      $this->version = $regs[1];
      $this->bot = true;
    }
    elseif (preg_match('|Firefox/([0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) {
      $this->brand = 'Firefox';
      $this->version = $regs[1];
      $this->bot = false;
    }
    elseif (preg_match('|Thunderbird/([0-9a-zA-Z\.+]+)|i', $this->uastring, $regs)) {
      $this->brand = 'Thunderbird';
      $this->version = $regs[1];
      $this->bot = false;
    }
    elseif (preg_match('|rv:([0-9a-zA-Z\.+]+)|', $this->uastring, $regs) &&
            strstr($this->uastring, "Mozilla/") && strstr($this->uastring, "Gecko/")) {
      $this->brand = 'Mozilla';
      $this->version = $regs[1];
      $this->bot = false;
    }
    elseif (preg_match('|m([0-9]+)\)|', $this->uastring, $regs) &&
            strstr($this->uastring, "Mozilla/") && strstr($this->uastring, "Gecko/")) {
      $this->brand = 'Mozilla';
      $this->version = 'M'.$regs[1];
      $this->bot = false;
    }
    elseif (preg_match('|Baiduspider|i', $this->uastring)) {
      $this->brand = 'BaiDuSpider';
      $this->version = null;
      $this->bot = true;
    }
    elseif (preg_match('|YodaoBot-Mobile/([0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) { /* looks like Gecko! */
      $this->brand = 'YodaoBot-Mobile';
      $this->version = $regs[1];
      $this->bot = true;
      $this->mobile = true;
    }
    elseif (preg_match('|FASTMobileCrawl/([0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) { /* looks like Gecko! */
      $this->brand = 'FASTMobileCrawl';
      $this->version = $regs[1];
      $this->bot = true;
      $this->mobile = true;
    }
    elseif (preg_match('|MSFrontPage/([0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) {
      $this->brand = 'Microsoft FrontPage';
      $this->version = $regs[1];
      $this->bot = false;
    }
    elseif (preg_match('|iCab[/ ]([0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) {
      $this->brand = 'iCab';
      $this->version = $regs[1];
      $this->bot = false;
    }
    elseif (preg_match('|IBrowse[/ ]([0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) {
      $this->brand = 'IBrowse';
      $this->version = $regs[1];
      $this->bot = false;
    }
    elseif (preg_match('|ICEbrowser/([0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) {
      $this->brand = 'ICEbrowser';
      $this->version = $regs[1];
      $this->bot = false;
    }
    elseif (preg_match('|ICE Browser/v([0-9a-zA-Z\._+]+)|', $this->uastring, $regs)) {
      $this->brand = 'ICEbrowser';
      $this->version = str_replace('_', '.', $regs[1]);
      $this->bot = false;
    }
    elseif (preg_match('|NetPositive/([0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) {
      $this->brand = 'NetPositive';
      $this->version = $regs[1];
      $this->bot = false;
    }
    elseif (preg_match('|WebPro/([0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) {
      $this->brand = 'WebPro (Novarra)';
      $this->version = $regs[1];
      $this->bot = false;
    }
    elseif (preg_match('|; OffByOne;|', $this->uastring, $regs)) {
      $this->brand = 'Off By One';
      $this->version = null;
      $this->bot = false;
    }
    elseif (preg_match('|PSP \(PlayStation Portable\); ([0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) {
      $this->brand = 'PlayStation Portable';
      $this->version = $regs[1];
      $this->bot = false;
      $this->mobile = true;
    }
    elseif (preg_match('|PLAYSTATION 3; ([0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) {
      $this->brand = 'PlayStation 3';
      $this->version = $regs[1];
      $this->bot = false;
    }
    elseif (preg_match('|NetFront/([0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) {
      $this->brand = 'NetFront';
      $this->version = $regs[1];
      $this->bot = false;
      $this->mobile = true;
    }
    elseif (preg_match('|UP.Browser/([0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) {
      $this->brand = 'UP.Browser';
      $this->version = $regs[1];
      $this->bot = false;
      $this->mobile = true;
    }
    elseif (preg_match('|UP.Link/([0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) {
      $this->brand = 'UP.Link';
      $this->version = $regs[1];
      $this->bot = false;
      $this->mobile = true;
    }
    elseif (preg_match('|AU-MIC-([0-9A-Z]+/[0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) {
      $this->brand = 'Obigo';
      $this->version = $regs[1];
      $this->bot = false;
      $this->mobile = true;
    }
    elseif (preg_match('|Browser/Obigo-([0-9A-Z]+/[0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) {
      $this->brand = 'Obigo';
      $this->version = $regs[1];
      $this->bot = false;
      $this->mobile = true;
    }
    elseif (preg_match('|Nokia([0-9a-zA-Z]+/[0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) {
      $this->brand = 'Nokia';
      $this->version = $regs[1];
      $this->bot = false;
      $this->mobile = true;
    }
    elseif (preg_match('|SonyEricsson([0-9a-zA-Z]+/[0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) {
      $this->brand = 'SonyEricsson';
      $this->version = $regs[1];
      $this->bot = false;
      $this->mobile = true;
    }
    elseif (preg_match('|SIE-([0-9a-zA-Z]+/[0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) {
      $this->brand = 'Siemens';
      $this->version = $regs[1];
      $this->bot = false;
      $this->mobile = true;
    }
    elseif (preg_match('|MOT-([0-9a-zA-Z]+/[0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) {
      $this->brand = 'Motorola';
      $this->version = $regs[1];
      $this->bot = false;
      $this->mobile = true;
    }
    elseif (preg_match('|IXI/([0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) {
      $this->brand = 'IXI';
      $this->version = $regs[1];
      $this->bot = false;
      $this->mobile = true;
    }
    elseif (preg_match('|NewsFox/([0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) {
      $this->brand = 'NewsFox';
      $this->version = $regs[1];
      $this->bot = false;
    }
    elseif (preg_match('|rdfbot/([0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) {
      $this->brand = 'rdfbot';
      $this->version = $regs[1];
      $this->bot = false;
    }
    elseif (preg_match('|IBM-WebExplorer-DLL/v([0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) {
      $this->brand = 'WebExplorer';
      $this->version = $regs[1];
      $this->bot = false;
    }
    elseif (preg_match('|ELinks \(([0-9a-zA-Z\.+]+);|', $this->uastring, $regs)) {
      $this->brand = 'ELinks';
      $this->version = $regs[1];
      $this->bot = false;
    }
    elseif (preg_match('|Links \(([0-9a-zA-Z\.+]+);|', $this->uastring, $regs)) {
      $this->brand = 'Links';
      $this->version = $regs[1];
      $this->bot = false;
    }
    elseif (preg_match('|WinHttp.WinHttpRequest.([0-9\.]+)|i', $this->uastring, $regs)) {
      $this->brand = 'WinHttpRequest';
      $this->version = $regs[1];
      $this->bot = false;
    }
    elseif (preg_match('|alpha[/ ]06; AmigaOS|i', $this->uastring, $regs)) {
      $this->brand = 'Alpha 06';
      $this->version = null;
      $this->bot = false;
    }
    elseif (preg_match('|; arexx[\);]|i', $this->uastring, $regs)) {
      $this->brand = 'ARexx';
      $this->version = null;
      $this->bot = false;
    }
    elseif (preg_match('|; Voyager; AmigaOS[\);]|i', $this->uastring, $regs)) {
      $this->brand = 'AmigaVoyager';
      $this->version = null;
      $this->bot = false;
    }
    elseif (preg_match('|AWEB ([0-9a-zA-Z\.+ ]+)|', $this->uastring, $regs)) {
      $this->brand = 'AWEB';
      $this->version = $regs[1];
      $this->bot = false;
    }
    elseif (preg_match('|X ([0-9a-zA-Z\.+ ]+); Commodore 64|', $this->uastring, $regs)) {
      $this->brand = 'X';
      $this->version = $regs[1];
      $this->bot = false;
    }
    elseif (preg_match('|DB Browse ([0-9a-zA-Z\.+]+)|i', $this->uastring, $regs)) {
      $this->brand = 'DB Browse';
      $this->version = $regs[1];
      $this->bot = false;
    }
    elseif (preg_match('|ZyBorg/([0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) {
      $this->brand = 'ZyBorg';
      $this->version = $regs[1];
      $this->bot = true;
    }
    elseif (preg_match('|Ask Jeeves/([0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) {
      $this->brand = 'Ask Jeeves';
      $this->version = $regs[1];
      $this->bot = true;
    }
    elseif (preg_match('|heritrix/([0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) {
      $this->brand = 'Heritrix';
      $this->version = $regs[1];
      $this->bot = true;
    }
    elseif (preg_match('|heritrix([0-9a-zA-Z\.+-]+)|', $this->uastring, $regs)) {
      $this->brand = 'Heritrix';
      $this->version = str_replace('-', '.', $regs[1]);
      $this->bot = true;
    }
    elseif (preg_match('|SBSearch/([0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) {
      $this->brand = 'SBSearch';
      $this->version = $regs[1];
      $this->bot = true;
    }
    elseif (preg_match('|Powermarks/([0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) {
      $this->brand = 'Powermarks';
      $this->version = $regs[1];
      $this->bot = true;
    }
    elseif (preg_match('|TopBlogsInfo/([0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) {
      $this->brand = 'TopBlogsInfo';
      $this->version = $regs[1];
      $this->bot = true;
    }
    elseif (preg_match('|picmole/([0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) {
      $this->brand = 'picmole';
      $this->version = $regs[1];
      $this->bot = true;
    }
    elseif (preg_match('|([0-9a-zA-Z\._+-]+bot)/([0-9a-zA-Z\.+]+)|i', $this->uastring, $regs)) {
      $this->brand = $regs[1];
      $this->version = $regs[2];
      $this->bot = true;
    }
    elseif (preg_match('|VoilaBot ((BETA )?[0-9a-zA-Z\.+]+)|i', $this->uastring, $regs)) {
      $this->brand = 'VoilaBot';
      $this->version = $regs[1];
      $this->bot = true;
    }
    elseif (preg_match('|Slurp|', $this->uastring, $regs)) {
      $this->brand = 'Slurp';
      $this->version = null;
      $this->bot = true;
    }
    elseif (preg_match('|Check&amp;Get ([0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) {
      $this->brand = 'Check&Get';
      $this->version = $regs[1];
      $this->bot = true;
    }
    elseif (preg_match('|WebCapture ([0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) {
      $this->brand = 'WebCapture';
      $this->version = $regs[1];
      $this->bot = true;
    }
    elseif (preg_match('|WebMon ([0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) {
      $this->brand = 'WebMon';
      $this->version = $regs[1];
      $this->bot = true;
    }
    elseif (preg_match('|Gulper Web Bot ([0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) {
      $this->brand = 'Gulper Web Bot';
      $this->version = $regs[1];
      $this->bot = true;
    }
    elseif (preg_match('|HTTrack ([0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) {
      $this->brand = 'HTTrack';
      $this->version = $regs[1];
      $this->bot = true;
    }
    elseif (preg_match('|Advista Crawler ([0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) {
      $this->brand = 'HTTrack';
      $this->version = $regs[1];
      $this->bot = true;
    }
    elseif (preg_match('|Seznam screenshot-generator ([0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) {
      $this->brand = 'Seznam screenshot-generator';
      $this->version = $regs[1];
      $this->bot = true;
    }
    elseif (preg_match('|Yahoo! SearchMonkey ([0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) {
      $this->brand = 'Yahoo! SearchMonkey';
      $this->version = $regs[1];
      $this->bot = true;
    }
    elseif (preg_match('|Yahoo Pipes ([0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) {
      $this->brand = 'Yahoo! Pipes';
      $this->version = $regs[1];
      $this->bot = true;
    }
    elseif (preg_match('|Firebat ([0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) {
      $this->brand = 'Firebat';
      $this->version = $regs[1];
      $this->bot = true;
    }
    elseif (preg_match('|Twiceler-([0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) {
      $this->brand = 'Twiceler';
      $this->version = $regs[1];
      $this->bot = true;
    }
    elseif (preg_match('|Nu_?tch-([0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) {
      $this->brand = 'Nutch';
      $this->version = $regs[1];
      $this->bot = true;
    }
    elseif (preg_match('|Microsoft URL Control - ([0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) {
      $this->brand = 'Microsoft URL Control';
      $this->version = $regs[1];
      $this->bot = true;
    }
    elseif (preg_match('|([0-9a-zA-Z\.+]+)_AC-Plug|', $this->uastring, $regs)) {
      $this->brand = 'AC-Plug';
      $this->version = $regs[1];
      $this->bot = true;
    }
    elseif (preg_match('|^Internet Explorer 5.5|', $this->uastring)) {
      $this->brand = 'Unknown bot (IE5.5)';
      $this->version = null;
      $this->bot = true;
    }
    elseif (preg_match('|^Mozilla[\s ]*$|', $this->uastring)) {
      $this->brand = 'Unknown bot (Mozilla)';
      $this->version = null;
      $this->bot = true;
    }
    elseif (preg_match('|ICCrawler|i', $this->uastring, $regs)) {
      $this->brand = 'ICCrawler';
      $this->version = null;
      $this->bot = true;
    }
    elseif (preg_match('|KaloogaBot|', $this->uastring, $regs)) {
      $this->brand = 'KaloogaBot';
      $this->version = null;
      $this->bot = true;
    }
    elseif (preg_match('|ScoutJet|', $this->uastring, $regs)) {
      $this->brand = 'ScoutJet';
      $this->version = null;
      $this->bot = true;
    }
    elseif (preg_match('|http://www.livedir.net|', $this->uastring, $regs)) {
      $this->brand = 'livedir.net';
      $this->version = null;
      $this->bot = true;
    }
    elseif (preg_match('|WebClipping.com|', $this->uastring, $regs)) {
      $this->brand = 'WebClipping.com';
      $this->version = null;
      $this->bot = true;
    }
    elseif (preg_match('|newstin.com|', $this->uastring, $regs)) {
      $this->brand = 'newstin.com';
      $this->version = null;
      $this->bot = true;
    }
    elseif (preg_match('|http://www.almaden.ibm.com/cs/crawler|', $this->uastring)) {
      $this->brand = 'almaden crawler';
      $this->version = null;
      $this->bot = true;
    }
    elseif (preg_match('|B-l-i-t-z-B-O-T|', $this->uastring) ||
            preg_match('|B l i t z B O T @ t r i c u s . n e t|', $this->uastring)) {
      $this->brand = 'BlitzBOT';
      $this->version = null;
      $this->bot = true;
    }
    elseif (preg_match('|Really Gmane.org\'s favicon grabber|', $this->uastring)) {
      $this->brand = 'Really Gmane.org\'s favicon grabber';
      $this->version = null;
      $this->bot = true;
    }
    elseif (preg_match('|Girafabot|', $this->uastring)) {
      $this->brand = 'Girafabot';
      $this->version = null;
      $this->bot = true;
    }
    elseif (preg_match('|Arachmo|', $this->uastring)) {
      $this->brand = 'Arachmo';
      $this->version = null;
      $this->bot = true;
    }
    elseif (preg_match('|OsO|', $this->uastring)) {
      $this->brand = 'OsO';
      $this->version = null;
      $this->bot = true;
    }
    elseif (preg_match('|Yoono|', $this->uastring)) {
      $this->brand = 'Yoono';
      $this->version = null;
      $this->bot = true;
    }
    elseif (preg_match('|efp@gmx.net|', $this->uastring)) {
      $this->brand = 'efp';
      $this->version = null;
      $this->bot = true;
    }
    elseif (preg_match('|Indy Library|', $this->uastring)) {
      $this->brand = 'Indy Library';
      $this->version = null;
      $this->bot = true;
    }
    elseif (preg_match('|Linkman|', $this->uastring)) {
      $this->brand = 'Linkman';
      $this->version = null;
      $this->bot = true;
    }
    elseif (preg_match('|Sage|', $this->uastring, $regs)) {
      $this->brand = 'Sage';
      $this->version = null;
      $this->bot = true;
    }
    elseif (preg_match('|Google Desktop|', $this->uastring)) {
      $this->brand = 'Google Desktop';
      $this->version = null;
      $this->bot = true;
    }
    elseif (preg_match('|^Firefly|', $this->uastring)) {
      // comes here with correct value but would be detected as MSIE
    }
    elseif (preg_match('|Steganos Internet Anonym([0-9a-zA-Z\. +]*)|', $this->uastring, $regs)) {
      $this->brand = 'Steganos Internet Anonym';
      $this->version = $regs[1];
      $this->bot = false;
    }
    elseif (preg_match('|Steganos Internet Anonym([0-9a-zA-Z\. +]*)|', $this->uastring, $regs)) {
      $this->brand = 'Steganos Internet Anonym';
      $this->version = $regs[1];
      $this->bot = false;
    }
    elseif (preg_match('|BorderManager ([0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) {
      $this->brand = 'BorderManager';
      $this->version = $regs[1];
      $this->bot = false;
    }
    elseif (preg_match('|WebWasher ([0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) {
      $this->brand = 'WebWasher';
      $this->version = $regs[1];
      $this->bot = false;
    }
    elseif (preg_match('|SaferSurf|', $this->uastring, $regs)) {
      $this->brand = 'SaferSurf';
      $this->version = null;
      $this->bot = false;
    }
    elseif (preg_match('|Avant Browser[^/]|', $this->uastring)) {
      $this->brand = 'Avant Browser';
      $this->version = null;
      $this->bot = false;
    }
    elseif (preg_match('|Browser[^/]+(http://www.avantbrowser.com)|', $this->uastring)) {
      $this->brand = 'Avant Browser';
      $this->version = null;
      $this->bot = false;
    }
    elseif (preg_match('|Maxthon|', $this->uastring)) {
      $this->brand = 'Maxthon';
      $this->version = null;
      $this->bot = false;
    }
    elseif (preg_match('|MyIE2|', $this->uastring)) {
      $this->brand = 'MyIE2';
      $this->version = null;
      $this->bot = false;
    }
    elseif (preg_match('|Crazy Browser ([0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) {
      $this->brand = 'Crazy Browser';
      $this->version = $regs[1];
      $this->bot = false;
    }
    elseif (preg_match('|AvantGo ([0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) {
      $this->brand = 'AvantGo';
      $this->version = $regs[1];
      $this->bot = false;
    }
    elseif (preg_match('|MSN ([0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) {
      $this->brand = 'MSN';
      $this->version = $regs[1];
      $this->bot = false;
    }
    elseif (preg_match('|America Online Browser [0-9a-zA-Z\.+]+; rev([0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) {
      $this->brand = 'AOL Browser';
      $this->version = $regs[1];
      $this->bot = false;
    }
    elseif (preg_match('|MS FrontPage ([0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) {
      $this->brand = 'Microsoft FrontPage';
      $this->version = $regs[1];
      $this->bot = false;
    }
    elseif (preg_match('|Microsoft Internet Explorer/4.0b1|', $this->uastring, $regs)) {
      $this->brand = 'Microsoft Internet Explorer';
      $this->version = '1.0';
      $this->bot = false;
    }
    elseif (preg_match('|MSIE 7\.0.+Trident/4.0|', $this->uastring, $regs)) {
      $this->brand = 'Microsoft Internet Explorer';
      $this->version = "8.0";
      $this->bot = false;
    }
    elseif (preg_match('|MSIE 7\.0.+Trident/5.0|', $this->uastring, $regs)) {
      $this->brand = 'Microsoft Internet Explorer';
      $this->version = "9.0";
      $this->bot = false;
    }
    elseif (preg_match('|MSIE 7\.0.+Trident/6.0|', $this->uastring, $regs)) {
      $this->brand = 'Microsoft Internet Explorer';
      $this->version = "10.0";
      $this->bot = false;
    }
    elseif (preg_match('|Trident\/[0-9a-zA-Z\.+]+; ([^\)]+; )?rv:([0-9\.+]+)|', $this->uastring, $regs)) {
      $this->brand = 'Microsoft Internet Explorer';
      $this->version = $regs[2];
      $this->bot = false;
    }
    elseif (preg_match('|MSIE ([0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) {
      $this->brand = 'Microsoft Internet Explorer';
      $this->version = $regs[1];
      $this->bot = false;
    }
    elseif (preg_match('|MSPIE ([0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) {
      $this->brand = 'Microsoft Pocket Internet Explorer';
      $this->version = $regs[1];
      $this->bot = false;
      $this->mobile = true;
    }
    elseif (preg_match('|Mozilla/([0-9a-zA-Z\.+]+)|', $this->uastring, $regs) &&
            (strpos($this->uastring, 'compatible') === false) && (strpos($this->uastring, 'Gecko/') === false) &&
            (intval($regs[1]) < 5)) {
      $this->brand = 'Netscape';
      $this->version = $regs[1];
      if (intval($this->version) == 4) { $this->brand .= ' Communicator'; }
      $this->bot = false;
    }
    elseif (preg_match('|Mozilla/([0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) {
      $this->brand = (strpos($this->uastring, 'compatible') !== false)?'Mozilla-compatible (unknown)':'Mozilla (unknown)';
      $this->version = null;
      $this->bot = false;
    }

    $botArray = array('Scooter','Spinne','Vagabondo','Firefly','Scrubby','NG','Pompos','Szukacz','Schmozilla','42_HAL',
                      'NetResearchServer','LinkWalker','Zeus','W3C_Validator','ZyBorg','Ask Jeeves','ia_archiver',
                      'PingALink Monitoring Services','IlTrovatore-Setaccio','Nutch','Mercator','search.ch',
                      'appie','larbin','NutchCVS','Webchat','Mediapartners-Google','sitecheck.internetseer.com',
                      'FavOrg','findlinks','DataCha0s','ichiro','Francis','CoralWebPrx','DoCoMo','Ocelli','Sogou Video',
                      'Yandex','Yeti','Austronaut-URL-Checker');

    if (in_array($this->brand, $botArray)) {
      $this->bot = true;
    }

    if (($this->brand == 'Microsoft Pocket Internet Explorer') ||
        (strpos($this->brand, 'BlackBerry') !== false)) {
      $this->mobile = true;
    }
  }

  public function getBrand() { return $this->brand; }
  public function getVersion() { return $this->version; }

  public function getAcceptLanguages() {
    if (!isset($this->uadata['accept-languages'])) {
      $headers = getAllHeaders();
      $accLcomp = explode(',', $headers['Accept-Language']);
      $accLang = array();
      foreach ($accLcomp as $lcomp) {
        if (strlen($lcomp)) {
          $ldef = explode(';', $lcomp);
          $accLang[$ldef[0]] = (float)((strpos(@$ldef[1],'q=')===0)?substr($ldef[1],2):1);
        }
      }
      $this->uadata['accept-languages'] = $accLang;
    }
  return $this->uadata['accept-languages'];
  }

  public function getUAString() { return $this->uastring; }

  public function getEngine() {
    // return gecko|khtml|trident|tasman|nscp|presto|gzilla|gtkhtml|links|icestorm|netfront|unknown
    if (!isset($this->uadata['engine'])) {
      $this->uadata['engine'] = 'unknown';
      $this->uadata['geckodate'] = null;
      if (!$this->bot) {
        if (preg_match('|Gecko/([0-9\.]+)|', $this->uastring, $regs) && (strpos($this->brand, 'Opera') === false)) {
          $this->uadata['engine'] = 'gecko';
          // If it looks like a version number, i.e. shorter than 4 chars or has a . in it, it's no date.
          if ((strlen($regs[1]) > 4) && (strpos($regs[1], '.') === false)) {
            $this->uadata['geckodate'] = $regs[1];
          }
          else {
            $this->uadata['geckodate'] = null;
            $this->uadata['eng_version'] = $regs[1];
          }
        }
        elseif (preg_match('|Edge/([0-9\.]+)|', $this->uastring, $regs)) {
          $this->uadata['engine'] = 'edgehtml';
          $this->uadata['eng_version'] = $regs[1];
        }
        elseif ((strpos($this->brand, 'Internet Explorer') !== false) ||  (strpos($this->brand, 'FrontPage') !== false)) {
          if ((strpos(strtolower($this->uastring), 'mac') !== false) && (intval($this->getVersion()) >= 5)) {
            $this->uadata['engine'] = 'tasman';
          }
          else {
            $this->uadata['engine'] = 'trident';
          }
        }
        elseif (preg_match('|WebKit/([0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) {
          $this->uadata['engine'] = 'webkit';
          $this->uadata['eng_version'] = $regs[1];
        }
        elseif ((strpos($this->brand, 'Konqueror') !== false) || (strpos($this->brand, 'OmniWeb') !== false)) {
          $this->uadata['engine'] = 'khtml';
        }
        elseif (strpos($this->brand, 'Netscape') !== false) {
          // non-Gecko Netscape browsers
          if (intval($this->version) <= 4) {
            $this->uadata['engine'] = 'nscp';
          }
          elseif (strpos($this->uastring, 'MSIE') !== false) {
            $this->uadata['engine'] = 'trident';
          }
        }
        elseif (strpos($this->brand, 'Opera') !== false) {
          $this->uadata['engine'] = 'presto';
        }
        elseif ((strpos($this->brand, 'iTunes') !== false) || (strpos($this->brand, 'nook browser') !== false)) {
          $this->uadata['engine'] = 'webkit';
        }
        elseif (strpos($this->brand, 'Dillo') !== false) {
          $this->uadata['engine'] = 'gzilla';
        }
        elseif ((strpos($this->brand, 'ELinks') !== false) || (strpos($this->brand, 'Links') !== false)) {
          $this->uadata['engine'] = 'links';
        }
        elseif ((strpos($this->brand, 'Lynx') !== false)) {
          $this->uadata['engine'] = 'lynx';
        }
        elseif ((strpos($this->brand, 'ICEbrowser') !== false) || (strpos($this->brand, 'ICE Browser') !== false)) {
          $this->uadata['engine'] = 'icestorm';
        }
        elseif (preg_match('|NetFront/([0-9a-zA-Z\.+]+)|', $this->uastring, $regs)) {
          $this->uadata['engine'] = 'netfront';
          $this->uadata['eng_version'] = $regs[1];
        }
        elseif ((strpos($this->brand, 'PlayStation') !== false) || (strpos($this->brand, 'NetFront') !== false)) {
          $this->uadata['engine'] = 'netfront';
        }
        elseif ((strpos($this->brand, 'Avant') !== false) || (strpos($this->brand, 'Crazy Browser') !== false) ||
                (strpos($this->brand, 'AOL') !== false) || (strpos($this->brand, 'MSN') !== false) ||
                (strpos($this->brand, 'MyIE2') !== false) || (strpos($this->brand, 'Maxthon') !== false)) {
          $this->uadata['engine'] = 'trident';
        }
        elseif (strpos($this->brand, 'Galeon') !== false) {
          $this->uadata['engine'] = 'gecko';
        }
        elseif (strpos($this->brand, 'WebPro') !== false) {
          $this->uadata['engine'] = 'nscp';
        }
      }
    }
  return $this->uadata['engine'];
  }

  public function hasEngine($rnd_engine) { return ($this->getEngine() == $rnd_engine); }

  public function getEngineVersion() {
    if (!isset($this->uadata['eng_version'])) {
      $this->uadata['eng_version'] = null;
      // getOS() should get the date for us
      $this->getOS();
    }
  return $this->uadata['eng_version'];
  }

  public function getOS() {
    if (!isset($this->uadata['os'])) {
      $this->uadata['os'] = null;
      if (!$this->bot) {
        if ($this->hasEngine('gecko')) {
          if (preg_match('|Mozilla/5.0 \(([^;]+); [^;]+; ([^;]+); ([^;]+); ([^;]+); rv:([^\);]+)(; [^\)]+)?\)|', $this->uastring, $regs)) {
            $this->uadata['os'] = $regs[2].' ('.$regs[3].')';
            $this->uadata['lang'] = (strpos($regs[4],'chrome://')===false)?$regs[4]:null;
            $this->uadata['eng_version'] = $regs[5];
          }
          elseif (preg_match('|Mozilla/5.0 \(([^;]+); [^;]+; ([^;]+); ([^;]+); rv:([^\);]+)(; [^\)]+)?\)|', $this->uastring, $regs)) {
            $this->uadata['os'] = $regs[2];
            $this->uadata['lang'] = (strpos($regs[3],'chrome://')===false)?$regs[3]:null;
            $this->uadata['eng_version'] = $regs[4];
          }
          elseif (preg_match('|Mozilla/5.0 \(([^;]+); [^;]; ([^;]+); rv:([^\);]+)(; [^\)]+)?\)|', $this->uastring, $regs)) {
            $this->uadata['os'] = $regs[2];
            $this->uadata['lang'] = null;
            $this->uadata['eng_version'] = $regs[3];
          }
          elseif (preg_match('|Mozilla/5.0 \(([^;]+); ([^;]+); x64; rv:([^\);]+)(; [^\)]+)?\)|', $this->uastring, $regs)) {
            $this->uadata['os'] =  $regs[1].' ('.$regs[2].')';
            $this->uadata['lang'] = null;
            $this->uadata['eng_version'] = $regs[3];
          }
          elseif (preg_match('|Mozilla/5.0 \(([^;]+); ([^;]+); ([^;]+); rv:([^\);]+)(; [^\)]+)?\)|', $this->uastring, $regs)) {
            $this->uadata['os'] = $regs[2];
            $this->uadata['lang'] = (strpos($regs[3],'chrome://')===false)?$regs[3]:null;
            $this->uadata['eng_version'] = $regs[4];
          }
          elseif (preg_match('|Mozilla/5.0 \(([^;]+); [^;]; ([^;]+); ([^;]+); m([^\);]+)\)|', $this->uastring, $regs)) {
            $this->uadata['os'] = $regs[2];
            $this->uadata['lang'] = $regs[3];
            $this->uadata['eng_version'] = 'M'.$regs[4];
          }
          elseif (preg_match('|Mozilla/5.0 \(([^;]+); [^;]; ([^;]+); m([^\);]+)\)|', $this->uastring, $regs)) {
            $this->uadata['os'] = $regs[1];
            $this->uadata['lang'] = $regs[2];
            $this->uadata['eng_version'] = 'M'.$regs[3];
          }
          elseif (preg_match('|Mozilla/5.0 \(([^;]+); [^;]; ([^;]+); ([^\);]+)\)|', $this->uastring, $regs)) {
            $this->uadata['os'] = $regs[2];
            $this->uadata['lang'] = $regs[3];
            $this->uadata['eng_version'] = null;
          }
          elseif (preg_match('#Mozilla/5.0 \(([^;]+); (WOW64|Mobile|Tablet); rv:([^\);]+)\)#', $this->uastring, $regs)) {
            $this->uadata['os'] = $regs[1].' ('.$regs[2].')';
            $this->uadata['lang'] = null;
            $this->uadata['eng_version'] = $regs[3];
            $this->mobile = ($regs[2] == 'Mobile');
          }
          elseif (preg_match('#Mozilla/5.0 \((Mobile|Tablet); [^;]+; rv:([^\);]+)\)#', $this->uastring, $regs)) {
            $this->uadata['os'] = 'Firefox OS ('.$regs[1].')';
            $this->uadata['lang'] = null;
            $this->uadata['eng_version'] = $regs[2];
            $this->mobile = ($regs[1] == 'Mobile');
          }
          elseif (preg_match('|Mozilla/5.0 \(([^;]+); ([^;]+); rv:([^\);]+)\)|', $this->uastring, $regs)) {
            if ((strpos($regs[2], 'Linux') !== false) && ($regs[1] != 'X11')) {
              $this->uadata['os'] = $regs[1].' ('.$regs[2].')';
            }
            else {
              $this->uadata['os'] = $regs[2];
            }
            $this->uadata['lang'] = null;
            $this->uadata['eng_version'] = $regs[3];
          }
          elseif (preg_match('|Mozilla/5.0 \(([^;]+); [^;]+; ([^\);]+)\)|', $this->uastring, $regs)) {
            $this->uadata['os'] = $regs[2];
            $this->uadata['lang'] = null;
            $this->uadata['eng_version'] = null;
          }
          elseif (preg_match('#Mozilla/5.0 \((Mobile|Tablet); rv:([^\);]+)\)#', $this->uastring, $regs)) {
            $this->uadata['os'] = 'Firefox OS ('.$regs[1].')';
            $this->uadata['lang'] = null;
            $this->uadata['eng_version'] = $regs[2];
            $this->mobile = ($regs[1] == 'Mobile');
          }
          elseif (preg_match('|Mozilla/5.0 \(([^;]+); rv:([^\);]+)\)|', $this->uastring, $regs)) {
            $this->uadata['os'] = $regs[1];
            $this->uadata['lang'] = null;
            $this->uadata['eng_version'] = $regs[2];
          }
          elseif (preg_match('|Mozilla/5.0 Galeon/[^\(]+ \(([^;]+); ([^;]+);[^\)]+\)|', $this->uastring, $regs)) {
            $this->uadata['os'] = $regs[2];
            $this->uadata['lang'] = null;
            $this->uadata['eng_version'] = null;
          }
          elseif (preg_match('|Debian/|', $this->uastring, $regs)) {
            $this->uadata['os'] = 'Debian Linux';
            $this->uadata['lang'] = null;
            $this->uadata['eng_version'] = null;
          }
        }
        elseif ($this->hasEngine('edgehtml')) {
          if (preg_match('#Mozilla/5.0 \(([^;]+); (WOW64|Win64); ([^\);]+)\)#', $this->uastring, $regs)) {
            $this->uadata['os'] = $regs[1].' ('.$regs[2].')';
          }
        }
        elseif ($this->hasEngine('trident') || $this->hasEngine('tasman')) {
          if (preg_match('/Mozilla\/[^\(]+ \((IE [^;]+[^\)]*; )?((?:Mac|Win)[^;]+); ?(Win64|WOW64); ?Trident\/([^;\)]+);/i', $this->uastring, $regs)) {
            $this->uadata['eng_version'] = $regs[4];
            $this->uadata['os'] = $regs[2].' ('.$regs[3].')';
            $this->uadata['lang'] = null;
          }
          elseif (preg_match('/Mozilla\/[^\(]+ \((IE [^;]+[^\)]*; )?((?:Mac|Win)[^;]+); ?Trident\/([^;\)]+);/i', $this->uastring, $regs)) {
            $this->uadata['eng_version'] = $regs[3];
            $this->uadata['os'] = $regs[2];
            $this->uadata['lang'] = null;
          }
          elseif (preg_match('/Mozilla\/[^\(]+ \(compatible *; MSIE [^;]+[^\)]*; ?((?:Mac|Win)[^;]+); ?(Win64|WOW64)[^\)]*Trident\/([^;\)]+)[^\)]*\)/i', $this->uastring, $regs)) {
            $this->uadata['eng_version'] = $regs[3];
            $this->uadata['os'] = $regs[1].' ('.$regs[2].')';
            $this->uadata['lang'] = null;
          }
          elseif (preg_match('/Mozilla\/[^\(]+ \(compatible *; MSIE [^;]+[^\)]*; ?((?:Mac|Win)[^;]+); ?[^\)]*Trident\/([^;\)]+)[^\)]*\)/i', $this->uastring, $regs)) {
            $this->uadata['eng_version'] = $regs[2];
            $this->uadata['os'] = $regs[1];
            $this->uadata['lang'] = null;
          }
          elseif (preg_match('/Mozilla\/[^\(]+ \(compatible *; MSP?IE ([^;]+)[^\)]*; ?((?:Mac|Win)[^;]+); ?(Win64|WOW64)[^\)]*\)/i', $this->uastring, $regs)) {
            $this->uadata['eng_version'] = (strpos($this->uastring,'MSPIE')!==false)?null:"ie".$regs[1];
            $this->uadata['os'] = $regs[2].' ('.$regs[3].')';
            $this->uadata['lang'] = null;
            $this->mobile = (strpos($this->uastring,'MSPIE') !== false);
          }
          elseif (preg_match('/Mozilla\/[^\(]+ \(compatible *; MSP?IE ([^;]+)[^\)]*; ?((?:Mac|Win)[^;]+)[^\)]*\)/i', $this->uastring, $regs)) {
            $this->uadata['eng_version'] = (strpos($this->uastring,'MSPIE')!==false)?null:"ie".$regs[1];
            $this->uadata['os'] = $regs[2];
            $this->uadata['lang'] = null;
            $this->mobile = (strpos($this->uastring,'MSPIE') !== false);
          }
          elseif (preg_match('/Mozilla\/[^\(]+ \(compatible *; MSIE ([^;]+)[^\)]*\)/i', $this->uastring, $regs)) {
            $this->uadata['eng_version'] = "ie".$regs[1];
            $this->uadata['os'] = null;
            $this->uadata['lang'] = null;
          }
          elseif (preg_match('/Microsoft Internet Explorer\/[^\s]+ \(((?:Mac|Win)[^;\)]+)\)/i', $this->uastring, $regs)) {
            $this->uadata['eng_version'] = "ie".$this->getVersion();
            $this->uadata['os'] = $regs[1];
            $this->uadata['lang'] = null;
          }
          elseif (preg_match('/Microsoft Pocket Internet Explorer\/[^\s]+/i', $this->uastring, $regs)) {
            $this->uadata['eng_version'] = null;
            $this->uadata['os'] = 'Windows CE';
            $this->uadata['lang'] = null;
          }
        }
        elseif ($this->hasEngine('khtml')) {
          if (preg_match('/Mozilla\/[^\(]+ \(compatible; Konqueror\/([^;]+); ([^;]+); ([^;]+); ([^;]+); ([^\);]+)\)(?: KHTML\/([0-9a-zA-Z\.+]+))?/i', $this->uastring, $regs)) {
            $this->uadata['eng_version'] = strlen($regs[6])?$regs[6]:$regs[1];
            $this->uadata['os'] = $regs[2];
            $this->uadata['lang'] = $regs[5];
          }
          elseif (preg_match('/Mozilla\/[^\(]+ \(compatible; Konqueror\/([^;]+); ([^\);]+)[^\)]*\)(?: KHTML\/([0-9a-zA-Z\.+]+))?/i', $this->uastring, $regs)) {
            $this->uadata['eng_version'] = strlen($regs[3])?$regs[3]:$regs[1];
            $this->uadata['os'] = $regs[2];
            $this->uadata['lang'] = null;
          }
          elseif (preg_match('/Mozilla\/[^\(]+ \(compatible; [^;]+; ([^\);]+)\)/i', $this->uastring, $regs)) {
            $this->uadata['os'] = $regs[1];
            $this->uadata['lang'] = null;
            $this->uadata['eng_version'] = null;
          }
        }
        elseif ($this->hasEngine('webkit')) {
          if (preg_match('|Mozilla/5.0 \(([^;]+); U; ([^\);]+); ([^\);]+); ([^\);]+)\)|', $this->uastring, $regs)) {
            $this->uadata['os'] = $regs[2];
            $this->uadata['lang'] = $regs[3];
          }
          elseif (preg_match('|Mozilla/5.0 \(([^;]+); U; ([^\);]+); ([^\);]+)\)|', $this->uastring, $regs)) {
            if (strpos($regs[3], '/') !== false) {
              $this->uadata['os'] = $regs[1];
              $this->uadata['lang'] = null;
            }
            else {
              $this->uadata['os'] = $regs[2];
              $this->uadata['lang'] = $regs[3];
            }
          }
          elseif (preg_match('|Mozilla/5.0 \(([^;]+); Linux; ([^;]+); U; ([^\);]+)\)|', $this->uastring, $regs)) {
            $this->uadata['os'] = $regs[2];
            $this->uadata['lang'] = $regs[3];
          }
          elseif (preg_match('|Mozilla/5.0 \(([^;]+); U; ([^\);]+)\)|', $this->uastring, $regs)) {
            $this->uadata['os'] = $regs[1];
            $this->uadata['lang'] = $regs[2];
          }
          elseif (preg_match('|Mozilla/5.0 \(Linux; ([^;]+); ([^\);]+)\)|', $this->uastring, $regs)) {
            // (Chrome for) Android - $regs[2] is device
            $this->uadata['os'] = $regs[1];
            $this->uadata['lang'] = null;
          }
          elseif (preg_match('|Mozilla/5.0 \(([^\);]+); ([^\);]+)\)|', $this->uastring, $regs)) {
            if (($regs[1] == 'X11') || ($regs[1] == 'Macintosh') || ($regs[1] == 'iPhone')) {
              $this->uadata['os'] = $regs[2];
            }
            else {
              $this->uadata['os'] = $regs[1];
              if ($regs[2] == 'NokiaN9') {
                 $this->uadata['os'] .= ' Harmattan';
              }
            }
            $this->uadata['lang'] = null;
          }
          elseif (preg_match('|Mozilla/5.0 \(([^\);]+)\)|', $this->uastring, $regs)) {
            $this->uadata['os'] = $regs[1];
            $this->uadata['lang'] = null;
          }
          elseif (preg_match('|Midori/[^\(]+ \((?:X11; )?([^;]+); U; ([^\)]+)\)|i', $this->uastring, $regs)) {
            $this->uadata['os'] = $regs[1];
            $this->uadata['lang'] = $regs[2];
          }
          if ($this->brand == 'Silk') {
            // For some reason, Amazon spoofs us and tells us it's on MacOS X!
            $this->uadata['os'] = 'Android';
          }
          if (preg_match('| Mobile |', $this->uastring)) {
            $this->mobile = true;
          }
        }
        elseif ($this->hasEngine('presto')) {
          // Opera < 8
          if (preg_match('/Opera\/[^\(]+ \((?:X11; )?([^;]+)[^\)]+\) +\[([a-z_-]+)\]/i', $this->uastring, $regs)) {
            $this->uadata['eng_version'] = $this->getVersion();
            $this->uadata['os'] = $regs[1];
            $this->uadata['lang'] = $regs[2];
          }
          elseif (preg_match('/Mozilla\/[^\(]+ \(compatible; MSIE [^;]+; (?:X11; )?([^;\)]+)[^\)]*\) Opera [^ ]+\s+\[([a-z_-]+)\]/i', $this->uastring, $regs)) {
            $this->uadata['eng_version'] = $this->getVersion();
            $this->uadata['os'] = $regs[1];
            $this->uadata['lang'] = $regs[2];
          }
          elseif (preg_match('/Mozilla\/[^\(]+ \((?:X11; )?([^;]+);.+\) Opera [^ ]+\s+\[([a-z_-]+)\]/i', $this->uastring, $regs)) {
            $this->uadata['eng_version'] = $this->getVersion();
            $this->uadata['os'] = $regs[1];
            $this->uadata['lang'] = $regs[2];
          }
          // Opera mini
          elseif (preg_match('/Opera\/([^\(]+) \((?:X11; )?([^;]+); Opera Mini; ([a-z_-]+); /i', $this->uastring, $regs)) {
            $this->uadata['eng_version'] = null;
            $this->uadata['os'] = $regs[2];
            $this->uadata['lang'] = $regs[3];
          }
          elseif (preg_match('/Opera\/([^\(]+) \((?:X11; )?([^;]+); Opera Mini\/[^;]+; ([a-z_-]+); /i', $this->uastring, $regs)) {
            $this->uadata['eng_version'] = $regs[1];
            $this->uadata['os'] = $regs[2];
            $this->uadata['lang'] = $regs[3];
          }
          // Opera >= 8
          elseif (preg_match('/Opera\/[^\(]+ \((?:X11; )?([^;]+); [^\)]+; ([a-z_-]+)\)/i', $this->uastring, $regs)) {
            $this->uadata['eng_version'] = $this->getVersion();
            $this->uadata['os'] = $regs[1];
            $this->uadata['lang'] = $regs[2];
          }
          elseif (preg_match('/Mozilla\/[^\(]+ \(compatible; MSIE [^;]+; (?:X11; )?([^;]+); ([a-z_-]+)\) Opera [^ ]+/i', $this->uastring, $regs)) {
            $this->uadata['eng_version'] = $this->getVersion();
            $this->uadata['os'] = $regs[1];
            $this->uadata['lang'] = $regs[2];
          }
          elseif (preg_match('/Mozilla\/[^\(]+ \((?:X11; )?([^;]+);.+; ([a-z_-]+)\) Opera [^ ]+/i', $this->uastring, $regs)) {
            $this->uadata['eng_version'] = $this->getVersion();
            $this->uadata['os'] = $regs[1];
            $this->uadata['lang'] = $regs[2];
          }
          // Opera 9 Firefox-spoofing
          elseif (preg_match('/Mozilla\/[^\(]+ \((?:X11; )?([^;]+);.+; ([a-z_-]+); rv:([^\);]+)\) Gecko\/\d+ Firefox\/[0-9a-zA-Z\.+]+ Opera [^ ]+/i', $this->uastring, $regs)) {
            $this->uadata['eng_version'] = $this->getVersion();
            $this->uadata['os'] = $regs[1];
            $this->uadata['lang'] = $regs[2];
          }
          if (preg_match('| Mobi|', $this->uastring)) {
            $this->mobile = true;
          }
        }
        elseif ($this->hasEngine('nscp')) {
          if (preg_match('/Mozilla\/([0-9a-zA-Z\.+]+) (?:\[([a-z_-]+)\][^\(]+)?\(X11; [^;]+; ([^\)]+)\)/i', $this->uastring, $regs)) {
            $this->uadata['eng_version'] = $regs[1];
            $this->uadata['os'] = $regs[3];
            $this->uadata['lang'] = $regs[2];
          }
          elseif (preg_match('/Mozilla\/([0-9a-zA-Z\.+]+) (?:\[([a-z_-]+)\][^\(]+)?\(([^;]+);[^\)]+\)/i', $this->uastring, $regs)) {
            $this->uadata['eng_version'] = $regs[1];
            $this->uadata['os'] = $regs[3];
            $this->uadata['lang'] = $regs[2];
          }
          elseif (preg_match('/Mozilla\/([0-9a-zA-Z\.+]+)[^\(]+\(([^;]+);[^\)]+\)/i', $this->uastring, $regs)) {
            $this->uadata['eng_version'] = $regs[1];
            $this->uadata['os'] = $regs[2];
            $this->uadata['lang'] = null;
          }
        }
        elseif ($this->hasEngine('gzilla')) {
          $this->uadata['eng_version'] = $this->getVersion();
          $this->uadata['os'] = null;
          $this->uadata['lang'] = null;
        }
        elseif ($this->hasEngine('links')) {
          if (preg_match('/E?Links[^\(]+\([^;]+; ([^;]+)[^\)]+\)/i', $this->uastring, $regs)) {
            $this->uadata['eng_version'] = null;
            $this->uadata['os'] = $regs[1];
            $this->uadata['lang'] = null;
          }
        }
        elseif ($this->hasEngine('lynx')) {
          $this->uadata['eng_version'] = $this->getVersion();
          $this->uadata['os'] = null;
          $this->uadata['lang'] = null;
        }
        elseif ($this->hasEngine('icestorm')) {
          if (preg_match('/ICE Browser\/v?([0-9a-zA-Z\._+]+) \(Java [^;]+; ([^\)]+)\)/i', $this->uastring, $regs)) {
            $this->uadata['eng_version'] = str_replace('_', '.', $regs[1]);
            $this->uadata['os'] = $regs[2];
            $this->uadata['lang'] = null;
          }
          elseif (preg_match('/Mozilla\/[^\(]+ \((?:X11; )?([^;]+);.+; ([a-z_-]+)\).* ICEbrowser\/([0-9a-zA-Z\._+]+)/i', $this->uastring, $regs)) {
            $this->uadata['eng_version'] = $regs[3];
            $this->uadata['os'] = $regs[1];
            $this->uadata['lang'] = $regs[2];
          }
        }
        else {
          $this->uadata['eng_version'] = null;
          $this->uadata['lang'] = null;
          if (preg_match('/AmigaOS/i', $this->uastring, $regs)) {
            $this->uadata['os'] = 'AmigaOS';
          }
          if (preg_match('/Commodore 64/i', $this->uastring, $regs)) {
            $this->uadata['os'] = 'Commodore 64';
          }
          elseif (preg_match('/curl\/[^\(]+\(([^\);]+)/i', $this->uastring, $regs)) {
            $this->uadata['os'] = $regs[1];
          }
          elseif (preg_match('/NCSA[_ ]Mosaic\/[^\(]+\((?:.*;)?([^\);]+)/i', $this->uastring, $regs)) {
            $this->uadata['os'] = trim($regs[1]);
          }
          elseif (preg_match('/iCab.*(Mac[^\);]+).*?\)/i', $this->uastring, $regs)) {
            $this->uadata['os'] = trim($regs[1]);
          }
          elseif (preg_match('/SymbianOS\/([^ ]+)/i', $this->uastring, $regs)) {
            $this->uadata['os'] = 'SymbianOS '.$regs[1];
          }
        }
        if ($this->uadata['os'] == 'Win 9x 4.90') { $this->uadata['os'] = 'Windows ME'; }
        elseif ($this->uadata['os'] == 'WinNT4.0') { $this->uadata['os'] = 'Windows NT 4.0'; }
        elseif ($this->uadata['os'] == 'Windows NT 5.0') { $this->uadata['os'] = 'Windows 2000'; }
        elseif ($this->uadata['os'] == 'Windows NT 5.1') { $this->uadata['os'] = 'Windows XP'; }
        elseif ($this->uadata['os'] == 'Windows NT 5.1 (Win64)') { $this->uadata['os'] = 'Windows XP (64bit)'; }
        elseif ($this->uadata['os'] == 'Windows NT 5.1 (WOW64)') { $this->uadata['os'] = 'Windows XP (64bit)'; }
        elseif ($this->uadata['os'] == 'Windows NT 5.2') { $this->uadata['os'] = 'Windows 2003'; }
        elseif ($this->uadata['os'] == 'Windows NT 5.2 x64') { $this->uadata['os'] = 'Windows 2003 (64bit)'; }
        elseif ($this->uadata['os'] == 'Windows NT 5.2 (Win64)') { $this->uadata['os'] = 'Windows 2003 (64bit)'; }
        elseif ($this->uadata['os'] == 'Windows NT 5.2 (WOW64)') { $this->uadata['os'] = 'Windows 2003 (64bit)'; }
        elseif ($this->uadata['os'] == 'Windows NT 6.0') { $this->uadata['os'] = 'Windows Vista'; }
        elseif ($this->uadata['os'] == 'Windows NT 6.0 (Win64)') { $this->uadata['os'] = 'Windows Vista (64bit)'; }
        elseif ($this->uadata['os'] == 'Windows NT 6.0 (WOW64)') { $this->uadata['os'] = 'Windows Vista (64bit)'; }
        elseif ($this->uadata['os'] == 'Windows NT 6.1') { $this->uadata['os'] = 'Windows 7'; }
        elseif ($this->uadata['os'] == 'Windows NT 6.1 (Win64)') { $this->uadata['os'] = 'Windows 7 (64bit)'; }
        elseif ($this->uadata['os'] == 'Windows NT 6.1 (WOW64)') { $this->uadata['os'] = 'Windows 7 (64bit)'; }
        elseif ($this->uadata['os'] == 'Windows NT 6.2') { $this->uadata['os'] = 'Windows 8'; }
        elseif ($this->uadata['os'] == 'Windows NT 6.2 (Win64)') { $this->uadata['os'] = 'Windows 8 (64bit)'; }
        elseif ($this->uadata['os'] == 'Windows NT 6.2 (WOW64)') { $this->uadata['os'] = 'Windows 8 (64bit)'; }
        elseif ($this->uadata['os'] == 'Windows NT 6.3') { $this->uadata['os'] = 'Windows 8.1'; }
        elseif ($this->uadata['os'] == 'Windows NT 6.3 (Win64)') { $this->uadata['os'] = 'Windows 8.1 (64bit)'; }
        elseif ($this->uadata['os'] == 'Windows NT 6.3 (WOW64)') { $this->uadata['os'] = 'Windows 8.1 (64bit)'; }
        elseif ($this->uadata['os'] == 'Windows NT 6.4') { $this->uadata['os'] = 'Windows 10'; }
        elseif ($this->uadata['os'] == 'Windows NT 6.4 (Win64)') { $this->uadata['os'] = 'Windows 10 (64bit)'; }
        elseif ($this->uadata['os'] == 'Windows NT 6.4 (WOW64)') { $this->uadata['os'] = 'Windows 10 (64bit)'; }
        elseif ($this->uadata['os'] == 'Windows NT 10.0') { $this->uadata['os'] = 'Windows 10'; }
        elseif ($this->uadata['os'] == 'Windows NT 10.0 (Win64)') { $this->uadata['os'] = 'Windows 10 (64bit)'; }
        elseif ($this->uadata['os'] == 'Windows NT 10.0 (WOW64)') { $this->uadata['os'] = 'Windows 10 (64bit)'; }
        elseif ($this->uadata['os'] == 'Win95') { $this->uadata['os'] = 'Windows 95'; }
        elseif ($this->uadata['os'] == 'Win98') { $this->uadata['os'] = 'Windows 98'; }
        elseif ($this->uadata['os'] == 'WinNT') { $this->uadata['os'] = 'Windows NT'; }
        elseif ($this->uadata['os'] == 'Win32') { $this->uadata['os'] = 'Windows (32bit)'; }
        elseif ($this->uadata['os'] == 'Win64') { $this->uadata['os'] = 'Windows (64bit)'; }
        elseif (preg_match('/iPhone OS ([\d_]+)/i', $this->uadata['os'], $regs)) { $this->uadata['os'] = 'iOS '.str_replace('_', '.', $regs[1]); }
        elseif (preg_match('/Mac ?OS ?X/i', $this->uadata['os'])) { $this->uadata['os'] = 'MacOS X'; }
        elseif (preg_match('/Mac_P(ower|)PC/i', $this->uadata['os'])) { $this->uadata['os'] = 'MacOS'; }
        elseif (strpos($this->uadata['os'], 'darwin') !== false) { $this->uadata['os'] = 'MacOS X'; }
        elseif (strpos($this->uadata['os'], 'Darwin') !== false) { $this->uadata['os'] = 'MacOS X'; }
        elseif (strpos($this->uadata['os'], 'apple') !== false) { $this->uadata['os'] = 'MacOS'; }
        elseif (strpos($this->uadata['os'], 'Macintosh') !== false) { $this->uadata['os'] = 'MacOS'; }
        elseif (preg_match('/(?:web|hpw)OS\/([0-9a-zA-Z\._+]+)/i', $this->uadata['os'], $regs)) { $this->uadata['os'] = 'webOS '.$regs[1]; }
        elseif (preg_match('/Android \(Linux (.+)\)/i', $this->uadata['os'], $regs)) { $this->uadata['os'] = 'Android '.$regs[1]; }
        elseif (strpos($this->uadata['os'], 'linux') !== false) { $this->uadata['os'] = 'Linux'; }
        elseif (preg_match('/SymbianOS[\/ ]([0-9a-zA-Z\._+]+)/i', $this->uastring, $regs)) { $this->uadata['os'] = 'SymbianOS '.$regs[1]; }
        elseif (preg_match('/Symbian ?OS/i', $this->uadata['os'])) { $this->uadata['os'] = 'SymbianOS'; }

        if (strpos($this->uadata['os'], 'Win') !== false) { $this->uadata['platform'] = 'Windows'; }
        elseif (strpos($this->uadata['os'], 'Mac') !== false) { $this->uadata['platform'] = 'Macintosh'; }
        elseif (strpos($this->uadata['os'], 'iOS') !== false) { $this->uadata['platform'] = 'Macintosh'; }
        elseif (strpos($this->uadata['os'], 'Linux') !== false) { $this->uadata['platform'] = 'Linux'; }
        elseif (strpos($this->uadata['os'], 'MeeGo') !== false) { $this->uadata['platform'] = 'Linux'; }
        elseif (strpos($this->uadata['os'], 'webOS') !== false) { $this->uadata['platform'] = 'Linux'; }
        elseif (strpos($this->uadata['os'], 'Android') !== false) { $this->uadata['platform'] = 'Android'; }
        elseif (strpos($this->uadata['os'], 'Firefox OS') !== false) { $this->uadata['platform'] = 'Firefox OS'; }
        elseif (strpos($this->uadata['os'], 'Solaris') !== false) { $this->uadata['platform'] = 'Solaris'; }
        elseif (strpos($this->uadata['os'], 'SunOS') !== false) { $this->uadata['platform'] = 'Solaris'; }
        elseif (strpos($this->uadata['os'], 'BeOS') !== false) { $this->uadata['platform'] = 'BeOS'; }
        elseif (strpos($this->uadata['os'], 'BePC') !== false) { $this->uadata['platform'] = 'BeOS'; }
        elseif (strpos($this->uadata['os'], 'FreeBSD') !== false) { $this->uadata['platform'] = 'FreeBSD'; }
        elseif (strpos($this->uadata['os'], 'OpenBSD') !== false) { $this->uadata['platform'] = 'OpenBSD'; }
        elseif (strpos($this->uadata['os'], 'NetBSD') !== false) { $this->uadata['platform'] = 'NetBSD'; }
        elseif (strpos($this->uadata['os'], 'AIX') !== false) { $this->uadata['platform'] = 'AIX'; }
        elseif (strpos($this->uadata['os'], 'IRIX') !== false) { $this->uadata['platform'] = 'IRIX'; }
        elseif (strpos($this->uadata['os'], 'HP-UX') !== false) { $this->uadata['platform'] = 'HP-UX'; }
        elseif (strpos($this->uadata['os'], 'AmigaOS') !== false) { $this->uadata['platform'] = 'Amiga'; }
        elseif (strpos($this->uadata['os'], 'webOS') !== false) { $this->uadata['platform'] = 'webOS'; }
        elseif (strpos($this->uadata['os'], 'Commodore 64') !== false) { $this->uadata['platform'] = 'C64'; }
        elseif (strpos($this->uadata['os'], 'OpenVMS') !== false) { $this->uadata['platform'] = 'OpenVMS'; }
        elseif (strpos($this->uadata['os'], 'Warp') !== false) { $this->uadata['platform'] = 'OS/2'; }
        elseif (strpos($this->uadata['os'], 'OS/2') !== false) { $this->uadata['platform'] = 'OS/2'; }
        elseif (strpos($this->uadata['os'], 'SymbianOS') !== false) { $this->uadata['platform'] = 'SymbianOS'; }
        elseif (strpos($this->uadata['os'], 'BlackBerry') !== false) { $this->uadata['platform'] = 'BlackBerry'; }
        elseif (strpos($this->uadata['os'], 'Gameboy') !== false) { $this->uadata['platform'] = 'Nintendo'; }
        elseif (strpos($this->uadata['os'], 'Wii') !== false) { $this->uadata['platform'] = 'Nintendo'; }
        elseif (strpos($this->uadata['os'], 'Nintendo') !== false) { $this->uadata['platform'] = 'Nintendo'; }
        elseif (strpos($this->uadata['os'], 'J2ME') !== false) { $this->uadata['platform'] = 'Java'; }
        elseif (strpos($this->uadata['os'], 'CYGWIN') !== false) { $this->uadata['platform'] = 'Windows'; }
        elseif (strpos($this->uadata['os'], 'mingw') !== false) { $this->uadata['platform'] = 'Windows'; }
        else { $this->uadata['platform'] = $this->uadata['os']; }

        if (strpos($this->uadata['os'], 'Windows Phone OS') !== false) { $this->mobile = true; }
        elseif (strpos($this->uadata['os'], 'Gameboy') !== false) { $this->mobile = true; }

        $this->uadata['lang'] = str_replace('_', '-', @$this->uadata['lang']);
      }
    }
  return $this->uadata['os'];
  }

  public function getPlatform() {
    if (!isset($this->uadata['platform'])) {
      $this->uadata['platform'] = null;
      // getOS() should get the date for us
      $this->getOS();
    }
  return $this->uadata['platform'];
  }

  public function getLanguage() {
    if (!isset($this->uadata['lang'])) {
      $this->uadata['lang'] = null;
      // getOS() should get the date for us
      $this->getOS();
    }
  return $this->uadata['lang'];
  }

  public function getGeckoDate() {
    if (!isset($this->uadata['geckodate'])) {
      $this->uadata['geckodate'] = null;
      // getEngine() should get the date for us
      $this->getEngine();
    }
  return $this->uadata['geckodate'];
  }

  public function getGeckoTime() {
    if (!isset($this->uadata['geckotime'])) {
      $this->uadata['geckotime'] = null;
      if (!is_null($this->getGeckoDate())) {
        $use_time = (strlen($this->getGeckoDate()) > 8);
        $gd_str = substr($this->getGeckoDate(),0,4).'-'.substr($this->getGeckoDate(),4,2).'-'.substr($this->getGeckoDate(),6,2);
        if ($use_time) {
          $gd_str .= substr($this->getGeckoDate(),8,2).':00';
          $old_tz = date_default_timezone_get();
          date_default_timezone_set("America/Los_Angeles");
        }
        $this->uadata['geckotime'] = strtotime($gd_str);
        if ($use_time) { date_default_timezone_set($old_tz); }
      }
    }
  return $this->uadata['geckotime'];
  }

  public function isBot() { return $this->bot; }

  public function isMobile() {
    if (!isset($this->uadata['os'])) {
      // getOS() makes sure that also the mobile tag is set correctly
      $this->getOS();
    }
    return $this->mobile;
  }

  public function isns() {
    trigger_error(__CLASS__.'::'.__FUNCTION__.' is a deprecated function', E_USER_NOTICE);
    return (strpos($this->brand, 'Netscape') !== false);
  }
  public function isns4() {
    trigger_error(__CLASS__.'::'.__FUNCTION__.' is a deprecated function', E_USER_NOTICE);
    return ((strpos($this->brand, 'Netscape') !== false) && (intval($this->version) == 4));
  }
  public function isie() {
    trigger_error(__CLASS__.'::'.__FUNCTION__.' is a deprecated function', E_USER_NOTICE);
    return $this->hasEngine('trident');
  }
  public function geckodate() {
    trigger_error(__CLASS__.'::'.__FUNCTION__.' is a deprecated function', E_USER_NOTICE);
    return (!is_null($this->getGeckoDate())?$this->getGeckoDate():0);
  }
  public function geckobased() {
    trigger_error(__CLASS__.'::'.__FUNCTION__.' is a deprecated function', E_USER_NOTICE);
    return $this->hasEngine('gecko');
  }
  public function khtmlbased() {
    trigger_error(__CLASS__.'::'.__FUNCTION__.' is a deprecated function', E_USER_NOTICE);
    return $this->hasEngine('khtml');
  }
}
?>
